"use strict";const SWI_OP_CODE={GBA_SWI_SOFT_RESET:0,GBA_SWI_REGISTER_RAM_RESET:1,GBA_SWI_HALT:2,GBA_SWI_STOP:3,GBA_SWI_INTR_WAIT:4,GBA_SWI_VBLANK_INTR_WAIT:5,GBA_SWI_DIV:6,GBA_SWI_DIV_ARM:7,GBA_SWI_SQRT:8,GBA_SWI_ARCTAN:9,GBA_SWI_ARCTAN2:10,GBA_SWI_CPU_SET:11,GBA_SWI_CPU_FAST_SET:12,GBA_SWI_GET_BIOS_CHECKSUM:13,GBA_SWI_BG_AFFINE_SET:14,GBA_SWI_OBJ_AFFINE_SET:15,GBA_SWI_BIT_UNPACK:16,GBA_SWI_LZ77_UNCOMP_WRAM:17,GBA_SWI_LZ77_UNCOMP_VRAM:18,GBA_SWI_HUFFMAN_UNCOMP:19,GBA_SWI_RL_UNCOMP_WRAM:20,GBA_SWI_RL_UNCOMP_VRAM:21,GBA_SWI_DIFF_8BIT_UNFILTER_WRAM:22,GBA_SWI_DIFF_8BIT_UNFILTER_VRAM:23,GBA_SWI_DIFF_16BIT_UNFILTER:24,GBA_SWI_SOUND_BIAS:25,GBA_SWI_SOUND_DRIVER_INIT:26,GBA_SWI_SOUND_DRIVER_MODE:27,GBA_SWI_SOUND_DRIVER_MAIN:28,GBA_SWI_SOUND_DRIVER_VSYNC:29,GBA_SWI_SOUND_CHANNEL_CLEAR:30,GBA_SWI_MIDI_KEY_2_FREQ:31,GBA_SWI_MUSIC_PLAYER_OPEN:32,GBA_SWI_MUSIC_PLAYER_START:33,GBA_SWI_MUSIC_PLAYER_STOP:34,GBA_SWI_MUSIC_PLAYER_CONTINUE:35,GBA_SWI_MUSIC_PLAYER_FADE_OUT:36,GBA_SWI_MULTI_BOOT:37,GBA_SWI_HARD_RESET:38,GBA_SWI_CUSTOM_HALT:39,GBA_SWI_SOUND_DRIVER_VSYNC_OFF:40,GBA_SWI_SOUND_DRIVER_VSYNC_ON:41,GBA_SWI_SOUND_DRIVER_GET_JUMP_LIST:42},CPU_MODES={USER:16,FIQ:17,IRQ:18,SUPERVISOR:19,ABORT:23,UNDEFINED:27,SYSTEM:31};function GameBoyAdvanceSWI(e,r,_){this.IOCore=e,this.CPUCore=r,this.IRQ=_,this.warnUnimplementedCalls=!1}GameBoyAdvanceSWI.prototype.execute=function(e){switch(e){case SWI_OP_CODE.GBA_SWI_SOFT_RESET:{let e=this.CPUCore.memory.readInternalWRAM8(32762);for(let e=32256;e<32256;e+=4)this.CPUCore.memory.writeInternalWRAM32(e,0);this.resetSP(),this.CPUCore.THUMB.writeLR(e?33554432:134217728),this.CPUCore.enterARM(),this.CPUCore.THUMB.writePC(this.CPUCore.THUMB.readLR())}break;case SWI_OP_CODE.GBA_SWI_REGISTER_RAM_RESET:{this.CPUCore.memory.gfxRenderer.writeDISPCNT8_0(128);let e=this.CPUCore.ARM.readRegister(0);1&e&&this.CPUCore.memory.externalRAM.fill(0,0,262144),2&e&&this.CPUCore.memory.internalRAM.fill(0,0,32256),4&e&&this.CPUCore.memory.gfxRenderer.renderer.paletteRAM.fill(0,0,1024),8&e&&this.CPUCore.memory.gfxRenderer.renderer.VRAM.fill(0,0,98304),16&e&&this.IOCore.gfxRenderer.renderer.objRenderer.OAMRAM.fill(0,1024),28&e&&this.warnUnimplementedCalls&&console.warn("UNSUPPORTED GBA_SWI_REGISTER_RAM_RESET REGISTER: 0x1C"),32&e&&this.warnUnimplementedCalls&&console.warn("UNSUPPORTED GBA_SWI_REGISTER_RAM_RESET REGISTER: 0x20"),64&e&&this.warnUnimplementedCalls&&console.warn("UNSUPPORTED GBA_SWI_REGISTER_RAM_RESET REGISTER: 0x40"),128&e&&this.warnUnimplementedCalls&&console.warn("UNSUPPORTED GBA_SWI_REGISTER_RAM_RESET REGISTER: 0x80"),156&e&&this.warnUnimplementedCalls&&console.warn("UNSUPPORTED GBA_SWI_REGISTER_RAM_RESET REGISTER: 0x9C")}break;case SWI_OP_CODE.GBA_SWI_HALT:this.IOCore.handleHalt();break;case SWI_OP_CODE.GBA_SWI_STOP:this.IOCore.handleStop();break;case SWI_OP_CODE.GBA_SWI_INTR_WAIT:assertIRQ();break;case SWI_OP_CODE.GBA_SWI_VBLANK_INTR_WAIT:this.IOCore.handleHalt();break;case SWI_OP_CODE.GBA_SWI_DIV:{let e=(0|this.CPUCore.ARM.readRegister(0))/(0|this.CPUCore.ARM.readRegister(1)),r=(0|this.CPUCore.ARM.readRegister(0))%(0|this.CPUCore.ARM.readRegister(1));this.CPUCore.ARM.writeRegister(0,0|e),this.CPUCore.ARM.writeRegister(1,0|r),this.CPUCore.ARM.writeRegister(3,Math.abs(0|e))}break;case SWI_OP_CODE.GBA_SWI_DIV_ARM:{let e=(0|this.CPUCore.ARM.readRegister(1))/(0|this.CPUCore.ARM.readRegister(0)),r=(0|this.CPUCore.ARM.readRegister(1))%(0|this.CPUCore.ARM.readRegister(0));this.CPUCore.ARM.writeRegister(0,0|e),this.CPUCore.ARM.writeRegister(1,0|r),this.CPUCore.ARM.writeRegister(3,Math.abs(0|e))}break;case SWI_OP_CODE.GBA_SWI_SQRT:{let e=Math.sqrt(this.CPUCore.ARM.readRegister(0));this.CPUCore.ARM.writeRegister(0,0|e)}break;case SWI_OP_CODE.GBA_SWI_ARCTAN:{let e=this.CPUCore.ARM.readRegister(0)/16384,r=this.CPUCore.ARM.readRegister(1)/16384;this.CPUCore.ARM.writeRegister(0,Math.atan(r,e)/(2*Math.PI)*65536)}break;case SWI_OP_CODE.GBA_SWI_ARCTAN2:{let e=this.CPUCore.ARM.readRegister(0)/16384,r=this.CPUCore.ARM.readRegister(1)/16384;this.CPUCore.ARM.writeRegister(0,Math.atan2(r,e)/(2*Math.PI)*65536);break}case SWI_OP_CODE.GBA_SWI_CPU_SET:{let e=this.CPUCore.ARM.readRegister(0),r=this.CPUCore.ARM.readRegister(1),_=this.CPUCore.ARM.readRegister(2),C=1048575&_,t=67108864&_?4:2;if(16777216&_)if(4==t){e&=4294967292,r&=4294967292;let _=this.CPUCore.memory.memoryRead32(e);for(let e=0;e<C;++e)this.CPUCore.memory.memoryWrite32(r+(e<<2),_)}else{e&=4294967294,r&=4294967294;let _=this.CPUCore.memory.memoryRead16(e);for(let e=0;e<C;++e)this.CPUCore.memory.memoryWrite16(r+(e<<1),_)}else if(4==t){e&=4294967292,r&=4294967292;for(let _=0;_<C;++_){let C=this.CPUCore.memory.memoryRead32(e+(_<<2));this.CPUCore.memory.memoryWrite32(r+(_<<2),C)}}else{e&=4294967294,r&=4294967294;for(let _=0;_<C;++_){let C=this.CPUCore.memory.memoryRead16(e+(_<<1));this.CPUCore.memory.memoryWrite16(r+(_<<1),C)}}}break;case SWI_OP_CODE.GBA_SWI_CPU_FAST_SET:{let e=4294967292&this.CPUCore.ARM.readRegister(0),r=4294967292&this.CPUCore.ARM.readRegister(1),_=this.CPUCore.ARM.readRegister(2),C=1048575&_;if(C=C+7>>3<<3,16777216&_){let _=this.CPUCore.memory.memoryRead32(e);for(let e=0;e<C;++e)this.CPUCore.memory.memoryWrite32(r+(e<<2),_)}else for(let _=0;_<C;++_){let C=this.CPUCore.memory.memoryRead32(e+(_<<2));this.CPUCore.memory.memoryWrite32(r+(_<<2),C)}}break;case SWI_OP_CODE.GBA_SWI_GET_BIOS_CHECKSUM:this.warnUnimplementedCalls&&console.warn("UNSUPPORTED CALL TO GBA_SWI_GET_BIOS_CHECKSUM");break;case SWI_OP_CODE.GBA_SWI_BG_AFFINE_SET:{let e,r,_,C,t,o,s,R,i,m,S,U,I,a=this.CPUCore.ARM.readRegister(2),A=this.CPUCore.ARM.readRegister(0),P=this.CPUCore.ARM.readRegister(1);for(;a--;)e=this.CPUCore.memory.memoryRead32(A)/256,r=this.CPUCore.memory.memoryRead32(A+4)/256,_=this.CPUCore.memory.memoryRead16(A+8),C=this.CPUCore.memory.memoryRead16(A+10),t=this.CPUCore.memory.memoryRead16(A+12)/256,o=this.CPUCore.memory.memoryRead16(A+14)/256,s=(this.CPUCore.memory.memoryRead16(A+16)>>8)/128*Math.PI,A+=20,R=S=Math.cos(s),i=m=Math.sin(s),R*=t,i*=-t,m*=o,S*=o,U=e-(R*_+i*C),I=r-(m*_+S*C),this.CPUCore.memory.memoryWrite16(P,256*R|0),this.CPUCore.memory.memoryWrite16(P+2,256*i|0),this.CPUCore.memory.memoryWrite16(P+4,256*m|0),this.CPUCore.memory.memoryWrite16(P+6,256*S|0),this.CPUCore.memory.memoryWrite32(P+8,256*U|0),this.CPUCore.memory.memoryWrite32(P+12,256*I|0),P+=16}break;case SWI_OP_CODE.GBA_SWI_OBJ_AFFINE_SET:{let e,r,_,C,t,o,s,R=this.CPUCore.ARM.readRegister(2),i=this.CPUCore.ARM.readRegister(0),m=this.CPUCore.ARM.readRegister(1),S=this.CPUCore.ARM.readRegister(3);for(;R--;)e=this.CPUCore.memory.memoryRead16(i)/256,r=this.CPUCore.memory.memoryRead16(i+2)/256,_=(this.CPUCore.memory.memoryRead16(i+4)>>8)/128*Math.PI,i+=6,C=s=Math.cos(_),t=o=Math.sin(_),C*=e,t*=-e,o*=r,s*=r,this.CPUCore.memory.memoryWrite16(m,256*C|0),this.CPUCore.memory.memoryWrite16(m+S,256*t|0),this.CPUCore.memory.memoryWrite16(m+2*S,256*o|0),this.CPUCore.memory.memoryWrite16(m+3*S,256*s|0),m+=4*S}break;case SWI_OP_CODE.GBA_SWI_BIT_UNPACK:this.warnUnimplementedCalls&&console.warn("UNSUPPORTED CALL TO GBA_SWI_BIT_UNPACK");break;case SWI_OP_CODE.GBA_SWI_LZ77_UNCOMP_WRAM:this.lz77(this.CPUCore.ARM.readRegister(0),this.CPUCore.ARM.readRegister(1),1);break;case SWI_OP_CODE.GBA_SWI_LZ77_UNCOMP_VRAM:this.lz77(this.CPUCore.ARM.readRegister(0),this.CPUCore.ARM.readRegister(1),2);break;case SWI_OP_CODE.GBA_SWI_HUFFMAN_UNCOMP:this.huffman(this.CPUCore.ARM.readRegister(0),this.CPUCore.ARM.readRegister(1));break;case SWI_OP_CODE.GBA_SWI_RL_UNCOMP_WRAM:this.rl(this.CPUCore.ARM.readRegister(0),this.CPUCore.ARM.readRegister(1),1);break;case SWI_OP_CODE.GBA_SWI_RL_UNCOMP_VRAM:this.rl(this.CPUCore.ARM.readRegister(0),this.CPUCore.ARM.readRegister(1),2);break;case SWI_OP_CODE.GBA_SWI_DIFF_8BIT_UNFILTER_WRAM:this.warnUnimplementedCalls&&console.warn("UNSUPPORTED CALL TO GBA_SWI_DIFF_8BIT_UNFILTER_WRAM");break;case SWI_OP_CODE.GBA_SWI_DIFF_8BIT_UNFILTER_VRAM:this.warnUnimplementedCalls&&console.warn("UNSUPPORTED CALL TO GBA_SWI_DIFF_8BIT_UNFILTER_VRAM");break;case SWI_OP_CODE.GBA_SWI_DIFF_16BIT_UNFILTER:this.warnUnimplementedCalls&&console.warn("UNSUPPORTED CALL TO GBA_SWI_DIFF_16BIT_UNFILTER");break;case SWI_OP_CODE.GBA_SWI_SOUND_BIAS:this.warnUnimplementedCalls&&console.warn("UNSUPPORTED CALL TO GBA_SWI_SOUND_BIAS");break;case SWI_OP_CODE.GBA_SWI_SOUND_DRIVER_INIT:this.warnUnimplementedCalls&&console.warn("UNSUPPORTED CALL TO GBA_SWI_SOUND_DRIVER_INIT");break;case SWI_OP_CODE.GBA_SWI_SOUND_DRIVER_MODE:this.warnUnimplementedCalls&&console.warn("UNSUPPORTED CALL TO GBA_SWI_SOUND_DRIVER_MODE");break;case SWI_OP_CODE.GBA_SWI_SOUND_DRIVER_MAIN:this.warnUnimplementedCalls&&console.warn("UNSUPPORTED CALL TO GBA_SWI_SOUND_DRIVER_MAIN");break;case SWI_OP_CODE.GBA_SWI_SOUND_DRIVER_VSYNC:this.warnUnimplementedCalls&&console.warn("UNSUPPORTED CALL TO GBA_SWI_SOUND_DRIVER_VSYNC");break;case SWI_OP_CODE.GBA_SWI_SOUND_CHANNEL_CLEAR:this.warnUnimplementedCalls&&console.warn("UNSUPPORTED CALL TO GBA_SWI_SOUND_CHANNEL_CLEAR");break;case SWI_OP_CODE.GBA_SWI_MIDI_KEY_2_FREQ:{let e=this.CPUCore.memory.memoryRead32(this.CPUCore.ARM.readRegister(0)+4);this.CPUCore.ARM.writeRegister(0,e/Math.pow(2,(180-this.CPUCore.ARM.readRegister(1)-this.CPUCore.ARM.readRegister(2)/256)/12)>>>0)}break;case SWI_OP_CODE.GBA_SWI_MUSIC_PLAYER_OPEN:this.warnUnimplementedCalls&&console.warn("UNSUPPORTED CALL TO GBA_SWI_MUSIC_PLAYER_OPEN");break;case SWI_OP_CODE.GBA_SWI_MUSIC_PLAYER_START:this.warnUnimplementedCalls&&console.warn("UNSUPPORTED CALL TO GBA_SWI_MUSIC_PLAYER_START");break;case SWI_OP_CODE.GBA_SWI_MUSIC_PLAYER_STOP:this.warnUnimplementedCalls&&console.warn("UNSUPPORTED CALL TO GBA_SWI_MUSIC_PLAYER_STOP");break;case SWI_OP_CODE.GBA_SWI_MUSIC_PLAYER_CONTINUE:this.warnUnimplementedCalls&&console.warn("UNSUPPORTED CALL TO GBA_SWI_MUSIC_PLAYER_CONTINUE");break;case SWI_OP_CODE.GBA_SWI_MUSIC_PLAYER_FADE_OUT:this.warnUnimplementedCalls&&console.warn("UNSUPPORTED CALL TO GBA_SWI_MUSIC_PLAYER_FADE_OUT");break;case SWI_OP_CODE.GBA_SWI_MULTI_BOOT:this.warnUnimplementedCalls&&console.warn("UNSUPPORTED CALL TO GBA_SWI_MULTI_BOOT");break;case SWI_OP_CODE.GBA_SWI_HARD_RESET:this.warnUnimplementedCalls&&console.warn("UNSUPPORTED CALL TO GBA_SWI_HARD_RESET");break;case SWI_OP_CODE.GBA_SWI_CUSTOM_HALT:this.warnUnimplementedCalls&&console.warn("UNSUPPORTED CALL TO GBA_SWI_CUSTOM_HALT");break;case SWI_OP_CODE.GBA_SWI_SOUND_DRIVER_VSYNC_OFF:this.warnUnimplementedCalls&&console.warn("UNSUPPORTED CALL TO GBA_SWI_SOUND_DRIVER_VSYNC_OFF");break;case SWI_OP_CODE.GBA_SWI_SOUND_DRIVER_VSYNC_ON:this.warnUnimplementedCalls&&console.warn("UNSUPPORTED CALL TO GBA_SWI_SOUND_DRIVER_VSYNC_ON");break;case SWI_OP_CODE.GBA_SWI_SOUND_DRIVER_GET_JUMP_LIST:this.IOCore.handleHalt();break;default:this.warnUnimplementedCalls&&console.log("UNKNOWN OP CODE: "+e)}},GameBoyAdvanceSWI.prototype.resetSP=function(){this.CPUCore.switchMode(CPU_MODES.SUPERVISOR),this.CPUCore.THUMB.writeSP(50364384),this.CPUCore.switchMode(CPU_MODES.IRQ),this.CPUCore.THUMB.writeSP(50364320),this.CPUCore.switchMode(CPU_MODES.SYSTEM),this.CPUCore.THUMB.writeSP(50364160)},GameBoyAdvanceSWI.prototype.lz77=function(e,r,_){let C,t,o,s,R,i=(4294967040&this.CPUCore.memory.memoryRead32(e))>>8,m=e+4,S=r,U=0,I=0;for(;i>0;)if(U){if(128&C)for(t=this.CPUCore.memory.memoryRead8(m)|this.CPUCore.memory.memoryRead8(m+1)<<8,m+=2,o=S-((15&t)<<8|(65280&t)>>8)-1,s=3+((240&t)>>4);s--&&i;)R=this.CPUCore.memory.memoryRead8(o++),2==_?(I>>=8,I|=R<<8,1&S&&this.CPUCore.memory.memoryWrite16(S-1,I)):this.CPUCore.memory.memoryWrite8(S,R),--i,++S;else R=this.CPUCore.memory.memoryRead8(m++),2==_?(I>>=8,I|=R<<8,1&S&&this.CPUCore.memory.memoryWrite16(S-1,I)):this.CPUCore.memory.memoryWrite8(S,R),--i,++S;C<<=1,--U}else C=this.CPUCore.memory.memoryRead8(m++),U=8},GameBoyAdvanceSWI.prototype.huffman=function(e,r){e&=4294967292;let _=this.CPUCore.memory.memoryRead32(e),C=_>>8,t=15&_;if(32%t)throw"Unimplemented unaligned Huffman";let o=4-C&3;C&=4294967292;let s,R,i,m=[],S=1+(this.CPUCore.memory.memoryRead8(e+4)<<1),U=e+5+S,I=4294967292&r;for(R=0;R<S;++R)m.push(this.CPUCore.memory.memoryRead8(e+5+R));let a,A,P=0,O=0;for(i=m[0];C>0;){let e=this.CPUCore.memory.memoryRead32(U);for(U+=4,a=32;a>0;--a,e<<=1){if("number"==typeof i){let e=(P-1|1)+((63&i)<<1)+2;i={l:e,r:e+1,lTerm:128&i,rTerm:64&i},m[P]=i}if(2147483648&e){if(!i.rTerm){P=i.r,i=m[i.r];continue}A=m[i.r]}else{if(!i.lTerm){P=i.l,i=m[P];continue}A=m[i.l]}s|=(A&(1<<t)-1)<<O,O+=t,P=0,i=m[0],32==O&&(O=0,this.CPUCore.memory.memoryWrite32(I,s),I+=4,C-=4,s=0)}}o&&this.CPUCore.memory.memoryWrite32(I,s)},GameBoyAdvanceSWI.prototype.rl=function(e,r,_){e&=4294967292;let C,t,o=(4294967040&this.CPUCore.memory.memoryRead32(e))>>8,s=4-o&3,R=e+4,i=r,m=0;for(;o>0;)if(C=this.CPUCore.memory.memoryRead8(R++),128&C)for(C&=127,C+=3,t=this.CPUCore.memory.memoryRead8(R++);C--&&o;)--o,2==_?(m>>=8,m|=t<<8,1&i&&this.CPUCore.memory.memoryWrite16(i-1,m)):this.CPUCore.memory.memoryWrite8(i,t),++i;else for(C++;C--&&o;)--o,t=this.CPUCore.memory.memoryRead8(R++),2==_?(m>>=8,m|=t<<8,1&i&&this.CPUCore.memory.memoryWrite16(i-1,m)):this.CPUCore.memory.memoryWrite8(i,t),++i;for(;s--;)this.CPUCore.memory.memoryWrite8(i++,0)};
//# sourceMappingURL=index.e437b668.js.map
