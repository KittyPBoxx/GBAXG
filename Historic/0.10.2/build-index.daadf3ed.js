"use strict";const SWI_OP_CODE={GBA_SWI_SOFT_RESET:0,GBA_SWI_REGISTER_RAM_RESET:1,GBA_SWI_HALT:2,GBA_SWI_STOP:3,GBA_SWI_INTR_WAIT:4,GBA_SWI_VBLANK_INTR_WAIT:5,GBA_SWI_DIV:6,GBA_SWI_DIV_ARM:7,GBA_SWI_SQRT:8,GBA_SWI_ARCTAN:9,GBA_SWI_ARCTAN2:10,GBA_SWI_CPU_SET:11,GBA_SWI_CPU_FAST_SET:12,GBA_SWI_GET_BIOS_CHECKSUM:13,GBA_SWI_BG_AFFINE_SET:14,GBA_SWI_OBJ_AFFINE_SET:15,GBA_SWI_BIT_UNPACK:16,GBA_SWI_LZ77_UNCOMP_WRAM:17,GBA_SWI_LZ77_UNCOMP_VRAM:18,GBA_SWI_HUFFMAN_UNCOMP:19,GBA_SWI_RL_UNCOMP_WRAM:20,GBA_SWI_RL_UNCOMP_VRAM:21,GBA_SWI_DIFF_8BIT_UNFILTER_WRAM:22,GBA_SWI_DIFF_8BIT_UNFILTER_VRAM:23,GBA_SWI_DIFF_16BIT_UNFILTER:24,GBA_SWI_SOUND_BIAS:25,GBA_SWI_SOUND_DRIVER_INIT:26,GBA_SWI_SOUND_DRIVER_MODE:27,GBA_SWI_SOUND_DRIVER_MAIN:28,GBA_SWI_SOUND_DRIVER_VSYNC:29,GBA_SWI_SOUND_CHANNEL_CLEAR:30,GBA_SWI_MIDI_KEY_2_FREQ:31,GBA_SWI_MUSIC_PLAYER_OPEN:32,GBA_SWI_MUSIC_PLAYER_START:33,GBA_SWI_MUSIC_PLAYER_STOP:34,GBA_SWI_MUSIC_PLAYER_CONTINUE:35,GBA_SWI_MUSIC_PLAYER_FADE_OUT:36,GBA_SWI_MULTI_BOOT:37,GBA_SWI_HARD_RESET:38,GBA_SWI_CUSTOM_HALT:39,GBA_SWI_SOUND_DRIVER_VSYNC_OFF:40,GBA_SWI_SOUND_DRIVER_VSYNC_ON:41,GBA_SWI_SOUND_DRIVER_GET_JUMP_LIST:42},CPU_MODES={USER:16,FIQ:17,IRQ:18,SUPERVISOR:19,ABORT:23,UNDEFINED:27,SYSTEM:31};function GameBoyAdvanceSWI(e,_,r){this.IOCore=e,this.CPUCore=_,this.IRQ=r,this.warnUnimplementedCalls=!1}GameBoyAdvanceSWI.prototype.execute=function(e){switch(e){case SWI_OP_CODE.GBA_SWI_SOFT_RESET:{let e=this.CPUCore.memory.readInternalWRAM8(32762);for(let e=32256;e<32256;e+=4)this.CPUCore.memory.writeInternalWRAM32(e,0);this.resetSP(),this.CPUCore.THUMB.writeLR(e?33554432:134217728),this.CPUCore.enterARM(),this.CPUCore.THUMB.writePC(this.CPUCore.THUMB.readLR())}break;case SWI_OP_CODE.GBA_SWI_REGISTER_RAM_RESET:{this.CPUCore.memory.gfxRenderer.writeDISPCNT8_0(128);let e=this.CPUCore.ARM.readRegister(0);1&e&&this.CPUCore.memory.externalRAM.fill(0,0,262144),2&e&&this.CPUCore.memory.internalRAM.fill(0,0,32256),4&e&&this.CPUCore.memory.gfxRenderer.renderer.paletteRAM.fill(0,0,1024),8&e&&this.CPUCore.memory.gfxRenderer.renderer.VRAM.fill(0,0,98304),16&e&&this.IOCore.gfxRenderer.renderer.objRenderer.OAMRAM.fill(0,1024),28&e&&this.warnUnimplementedCalls&&console.warn("UNSUPPORTED GBA_SWI_REGISTER_RAM_RESET REGISTER: 0x1C"),32&e&&this.warnUnimplementedCalls&&console.warn("UNSUPPORTED GBA_SWI_REGISTER_RAM_RESET REGISTER: 0x20"),64&e&&this.warnUnimplementedCalls&&console.warn("UNSUPPORTED GBA_SWI_REGISTER_RAM_RESET REGISTER: 0x40"),128&e&&this.warnUnimplementedCalls&&console.warn("UNSUPPORTED GBA_SWI_REGISTER_RAM_RESET REGISTER: 0x80"),156&e&&this.warnUnimplementedCalls&&console.warn("UNSUPPORTED GBA_SWI_REGISTER_RAM_RESET REGISTER: 0x9C")}break;case SWI_OP_CODE.GBA_SWI_HALT:this.IOCore.handleHalt();break;case SWI_OP_CODE.GBA_SWI_STOP:this.IOCore.handleStop();break;case SWI_OP_CODE.GBA_SWI_INTR_WAIT:assertIRQ();break;case SWI_OP_CODE.GBA_SWI_VBLANK_INTR_WAIT:this.IOCore.handleHalt();break;case SWI_OP_CODE.GBA_SWI_DIV:{let e=(0|this.CPUCore.ARM.readRegister(0))/(0|this.CPUCore.ARM.readRegister(1)),_=(0|this.CPUCore.ARM.readRegister(0))%(0|this.CPUCore.ARM.readRegister(1));this.CPUCore.ARM.writeRegister(0,0|e),this.CPUCore.ARM.writeRegister(1,0|_),this.CPUCore.ARM.writeRegister(3,Math.abs(0|e))}break;case SWI_OP_CODE.GBA_SWI_DIV_ARM:{let e=(0|this.CPUCore.ARM.readRegister(1))/(0|this.CPUCore.ARM.readRegister(0)),_=(0|this.CPUCore.ARM.readRegister(1))%(0|this.CPUCore.ARM.readRegister(0));this.CPUCore.ARM.writeRegister(0,0|e),this.CPUCore.ARM.writeRegister(1,0|_),this.CPUCore.ARM.writeRegister(3,Math.abs(0|e))}break;case SWI_OP_CODE.GBA_SWI_SQRT:{let e=Math.sqrt(this.CPUCore.ARM.readRegister(0));this.CPUCore.ARM.writeRegister(0,0|e)}break;case SWI_OP_CODE.GBA_SWI_ARCTAN:{let e=this.CPUCore.ARM.readRegister(0)/16384,_=this.CPUCore.ARM.readRegister(1)/16384;this.CPUCore.ARM.writeRegister(0,Math.atan(_,e)/(2*Math.PI)*65536)}break;case SWI_OP_CODE.GBA_SWI_ARCTAN2:{let e=this.CPUCore.ARM.readRegister(0)/16384,_=this.CPUCore.ARM.readRegister(1)/16384;this.CPUCore.ARM.writeRegister(0,Math.atan2(_,e)/(2*Math.PI)*65536);break}case SWI_OP_CODE.GBA_SWI_CPU_SET:{let e=this.CPUCore.ARM.readRegister(0),_=this.CPUCore.ARM.readRegister(1),r=this.CPUCore.ARM.readRegister(2),C=1048575&r,S=67108864&r?4:2;if(16777216&r)if(4==S){e&=4294967292,_&=4294967292;let r=this.CPUCore.memory.memoryRead32(e);for(let e=0;e<C;++e)this.CPUCore.memory.memoryWrite32(_+(e<<2),r)}else{e&=4294967294,_&=4294967294;let r=this.CPUCore.memory.memoryRead16(e);for(let e=0;e<C;++e)this.CPUCore.memory.memoryWrite16(_+(e<<1),r)}else if(4==S){e&=4294967292,_&=4294967292;for(let r=0;r<C;++r){let C=this.CPUCore.memory.memoryRead32(e+(r<<2));this.CPUCore.memory.memoryWrite32(_+(r<<2),C)}}else{e&=4294967294,_&=4294967294;for(let r=0;r<C;++r){let C=this.CPUCore.memory.memoryRead16(e+(r<<1));this.CPUCore.memory.memoryWrite16(_+(r<<1),C)}}}break;case SWI_OP_CODE.GBA_SWI_CPU_FAST_SET:{let e=4294967292&this.CPUCore.ARM.readRegister(0),_=4294967292&this.CPUCore.ARM.readRegister(1),r=this.CPUCore.ARM.readRegister(2),C=1048575&r;if(C=C+7>>3<<3,16777216&r){let r=this.CPUCore.memory.memoryRead32(e);for(let e=0;e<C;++e)this.CPUCore.memory.memoryWrite32(_+(e<<2),r)}else for(let r=0;r<C;++r){let C=this.CPUCore.memory.memoryRead32(e+(r<<2));this.CPUCore.memory.memoryWrite32(_+(r<<2),C)}}break;case SWI_OP_CODE.GBA_SWI_GET_BIOS_CHECKSUM:this.warnUnimplementedCalls&&console.warn("UNSUPPORTED CALL TO GBA_SWI_GET_BIOS_CHECKSUM");break;case SWI_OP_CODE.GBA_SWI_BG_AFFINE_SET:{let e,_,r,C,S,t,I,s,o,R,A,a,i,U=this.CPUCore.ARM.readRegister(2),P=this.CPUCore.ARM.readRegister(0),m=this.CPUCore.ARM.readRegister(1);for(;U--;)e=this.CPUCore.memory.memoryRead32(P)/256,_=this.CPUCore.memory.memoryRead32(P+4)/256,r=this.CPUCore.memory.memoryRead16(P+8),C=this.CPUCore.memory.memoryRead16(P+10),S=this.CPUCore.memory.memoryRead16(P+12)/256,t=this.CPUCore.memory.memoryRead16(P+14)/256,I=(this.CPUCore.memory.memoryRead16(P+16)>>8)/128*Math.PI,P+=20,s=A=Math.cos(I),o=R=Math.sin(I),s*=S,o*=-S,R*=t,A*=t,a=e-(s*r+o*C),i=_-(R*r+A*C),this.CPUCore.memory.memoryWrite16(m,256*s|0),this.CPUCore.memory.memoryWrite16(m+2,256*o|0),this.CPUCore.memory.memoryWrite16(m+4,256*R|0),this.CPUCore.memory.memoryWrite16(m+6,256*A|0),this.CPUCore.memory.memoryWrite32(m+8,256*a|0),this.CPUCore.memory.memoryWrite32(m+12,256*i|0),m+=16}break;case SWI_OP_CODE.GBA_SWI_OBJ_AFFINE_SET:{let e,_,r,C,S,t,I,s=this.CPUCore.ARM.readRegister(2),o=this.CPUCore.ARM.readRegister(0),R=this.CPUCore.ARM.readRegister(1),A=this.CPUCore.ARM.readRegister(3);for(;s--;)e=this.CPUCore.memory.memoryRead16(o)/256,_=this.CPUCore.memory.memoryRead16(o+2)/256,r=(this.CPUCore.memory.memoryRead16(o+4)>>8)/128*Math.PI,o+=6,C=I=Math.cos(r),S=t=Math.sin(r),C*=e,S*=-e,t*=_,I*=_,this.CPUCore.memory.memoryWrite16(R,256*C|0),this.CPUCore.memory.memoryWrite16(R+A,256*S|0),this.CPUCore.memory.memoryWrite16(R+2*A,256*t|0),this.CPUCore.memory.memoryWrite16(R+3*A,256*I|0),R+=4*A}break;case SWI_OP_CODE.GBA_SWI_BIT_UNPACK:this.warnUnimplementedCalls&&console.warn("UNSUPPORTED CALL TO GBA_SWI_BIT_UNPACK");break;case SWI_OP_CODE.GBA_SWI_LZ77_UNCOMP_WRAM:this.lz77(this.CPUCore.ARM.readRegister(0),this.CPUCore.ARM.readRegister(1),1);break;case SWI_OP_CODE.GBA_SWI_LZ77_UNCOMP_VRAM:this.lz77(this.CPUCore.ARM.readRegister(0),this.CPUCore.ARM.readRegister(1),2);break;case SWI_OP_CODE.GBA_SWI_HUFFMAN_UNCOMP:this.huffman(this.CPUCore.ARM.readRegister(0),this.CPUCore.ARM.readRegister(1));break;case SWI_OP_CODE.GBA_SWI_RL_UNCOMP_WRAM:this.rl(this.CPUCore.ARM.readRegister(0),this.CPUCore.ARM.readRegister(1),1);break;case SWI_OP_CODE.GBA_SWI_RL_UNCOMP_VRAM:this.rl(this.CPUCore.ARM.readRegister(0),this.CPUCore.ARM.readRegister(1),2);break;case SWI_OP_CODE.GBA_SWI_DIFF_8BIT_UNFILTER_WRAM:this.warnUnimplementedCalls&&console.warn("UNSUPPORTED CALL TO GBA_SWI_DIFF_8BIT_UNFILTER_WRAM");break;case SWI_OP_CODE.GBA_SWI_DIFF_8BIT_UNFILTER_VRAM:this.warnUnimplementedCalls&&console.warn("UNSUPPORTED CALL TO GBA_SWI_DIFF_8BIT_UNFILTER_VRAM");break;case SWI_OP_CODE.GBA_SWI_DIFF_16BIT_UNFILTER:this.warnUnimplementedCalls&&console.warn("UNSUPPORTED CALL TO GBA_SWI_DIFF_16BIT_UNFILTER");break;case SWI_OP_CODE.GBA_SWI_SOUND_BIAS:this.warnUnimplementedCalls&&console.warn("UNSUPPORTED CALL TO GBA_SWI_SOUND_BIAS");break;case SWI_OP_CODE.GBA_SWI_SOUND_DRIVER_INIT:this.warnUnimplementedCalls&&console.warn("UNSUPPORTED CALL TO GBA_SWI_SOUND_DRIVER_INIT");break;case SWI_OP_CODE.GBA_SWI_SOUND_DRIVER_MODE:this.warnUnimplementedCalls&&console.warn("UNSUPPORTED CALL TO GBA_SWI_SOUND_DRIVER_MODE");break;case SWI_OP_CODE.GBA_SWI_SOUND_DRIVER_MAIN:this.warnUnimplementedCalls&&console.warn("UNSUPPORTED CALL TO GBA_SWI_SOUND_DRIVER_MAIN");break;case SWI_OP_CODE.GBA_SWI_SOUND_DRIVER_VSYNC:this.warnUnimplementedCalls&&console.warn("UNSUPPORTED CALL TO GBA_SWI_SOUND_DRIVER_VSYNC");break;case SWI_OP_CODE.GBA_SWI_SOUND_CHANNEL_CLEAR:this.warnUnimplementedCalls&&console.warn("UNSUPPORTED CALL TO GBA_SWI_SOUND_CHANNEL_CLEAR");break;case SWI_OP_CODE.GBA_SWI_MIDI_KEY_2_FREQ:{let e=this.CPUCore.memory.memoryRead32(this.CPUCore.ARM.readRegister(0)+4);this.CPUCore.ARM.writeRegister(0,e/Math.pow(2,(180-this.CPUCore.ARM.readRegister(1)-this.CPUCore.ARM.readRegister(2)/256)/12)>>>0)}break;case SWI_OP_CODE.GBA_SWI_MUSIC_PLAYER_OPEN:this.warnUnimplementedCalls&&console.warn("UNSUPPORTED CALL TO GBA_SWI_MUSIC_PLAYER_OPEN");break;case SWI_OP_CODE.GBA_SWI_MUSIC_PLAYER_START:this.warnUnimplementedCalls&&console.warn("UNSUPPORTED CALL TO GBA_SWI_MUSIC_PLAYER_START");break;case SWI_OP_CODE.GBA_SWI_MUSIC_PLAYER_STOP:this.warnUnimplementedCalls&&console.warn("UNSUPPORTED CALL TO GBA_SWI_MUSIC_PLAYER_STOP");break;case SWI_OP_CODE.GBA_SWI_MUSIC_PLAYER_CONTINUE:this.warnUnimplementedCalls&&console.warn("UNSUPPORTED CALL TO GBA_SWI_MUSIC_PLAYER_CONTINUE");break;case SWI_OP_CODE.GBA_SWI_MUSIC_PLAYER_FADE_OUT:this.warnUnimplementedCalls&&console.warn("UNSUPPORTED CALL TO GBA_SWI_MUSIC_PLAYER_FADE_OUT");break;case SWI_OP_CODE.GBA_SWI_MULTI_BOOT:this.warnUnimplementedCalls&&console.warn("UNSUPPORTED CALL TO GBA_SWI_MULTI_BOOT");break;case SWI_OP_CODE.GBA_SWI_HARD_RESET:this.warnUnimplementedCalls&&console.warn("UNSUPPORTED CALL TO GBA_SWI_HARD_RESET");break;case SWI_OP_CODE.GBA_SWI_CUSTOM_HALT:this.warnUnimplementedCalls&&console.warn("UNSUPPORTED CALL TO GBA_SWI_CUSTOM_HALT");break;case SWI_OP_CODE.GBA_SWI_SOUND_DRIVER_VSYNC_OFF:this.warnUnimplementedCalls&&console.warn("UNSUPPORTED CALL TO GBA_SWI_SOUND_DRIVER_VSYNC_OFF");break;case SWI_OP_CODE.GBA_SWI_SOUND_DRIVER_VSYNC_ON:this.warnUnimplementedCalls&&console.warn("UNSUPPORTED CALL TO GBA_SWI_SOUND_DRIVER_VSYNC_ON");break;case SWI_OP_CODE.GBA_SWI_SOUND_DRIVER_GET_JUMP_LIST:this.IOCore.handleHalt();break;default:this.warnUnimplementedCalls&&console.log("UNKNOWN OP CODE: "+e)}},GameBoyAdvanceSWI.prototype.checkSupport=function(e){switch(e){case SWI_OP_CODE.GBA_SWI_SOFT_RESET:case SWI_OP_CODE.GBA_SWI_REGISTER_RAM_RESET:case SWI_OP_CODE.GBA_SWI_HALT:return!0;case SWI_OP_CODE.GBA_SWI_STOP:case SWI_OP_CODE.GBA_SWI_INTR_WAIT:case SWI_OP_CODE.GBA_SWI_VBLANK_INTR_WAIT:return!1;case SWI_OP_CODE.GBA_SWI_DIV:case SWI_OP_CODE.GBA_SWI_DIV_ARM:case SWI_OP_CODE.GBA_SWI_SQRT:case SWI_OP_CODE.GBA_SWI_ARCTAN:case SWI_OP_CODE.GBA_SWI_ARCTAN2:case SWI_OP_CODE.GBA_SWI_CPU_SET:case SWI_OP_CODE.GBA_SWI_CPU_FAST_SET:return!0;case SWI_OP_CODE.GBA_SWI_GET_BIOS_CHECKSUM:return!1;case SWI_OP_CODE.GBA_SWI_BG_AFFINE_SET:return!0;case SWI_OP_CODE.GBA_SWI_OBJ_AFFINE_SET:return usingInstantText;case SWI_OP_CODE.GBA_SWI_BIT_UNPACK:return!1;case SWI_OP_CODE.GBA_SWI_LZ77_UNCOMP_WRAM:case SWI_OP_CODE.GBA_SWI_LZ77_UNCOMP_VRAM:case SWI_OP_CODE.GBA_SWI_HUFFMAN_UNCOMP:case SWI_OP_CODE.GBA_SWI_RL_UNCOMP_WRAM:case SWI_OP_CODE.GBA_SWI_RL_UNCOMP_VRAM:return!0;case SWI_OP_CODE.GBA_SWI_DIFF_8BIT_UNFILTER_WRAM:case SWI_OP_CODE.GBA_SWI_DIFF_8BIT_UNFILTER_VRAM:case SWI_OP_CODE.GBA_SWI_DIFF_16BIT_UNFILTER:case SWI_OP_CODE.GBA_SWI_SOUND_BIAS:case SWI_OP_CODE.GBA_SWI_SOUND_DRIVER_INIT:case SWI_OP_CODE.GBA_SWI_SOUND_DRIVER_MODE:case SWI_OP_CODE.GBA_SWI_SOUND_DRIVER_MAIN:case SWI_OP_CODE.GBA_SWI_SOUND_DRIVER_VSYNC:case SWI_OP_CODE.GBA_SWI_SOUND_CHANNEL_CLEAR:return!1;case SWI_OP_CODE.GBA_SWI_MIDI_KEY_2_FREQ:return!0;default:return!1}},GameBoyAdvanceSWI.prototype.resetSP=function(){this.CPUCore.switchMode(CPU_MODES.SUPERVISOR),this.CPUCore.THUMB.writeSP(50364384),this.CPUCore.switchMode(CPU_MODES.IRQ),this.CPUCore.THUMB.writeSP(50364320),this.CPUCore.switchMode(CPU_MODES.SYSTEM),this.CPUCore.THUMB.writeSP(50364160)},GameBoyAdvanceSWI.prototype.lz77=function(e,_,r){let C,S,t,I,s,o=(4294967040&this.CPUCore.memory.memoryRead32(e))>>8,R=e+4,A=_,a=0,i=0;for(;o>0;)if(a){if(128&C)for(S=this.CPUCore.memory.memoryRead8(R)|this.CPUCore.memory.memoryRead8(R+1)<<8,R+=2,t=A-((15&S)<<8|(65280&S)>>8)-1,I=3+((240&S)>>4);I--&&o;)s=this.CPUCore.memory.memoryRead8(t++),2==r?(i>>=8,i|=s<<8,1&A&&this.CPUCore.memory.memoryWrite16(A-1,i)):this.CPUCore.memory.memoryWrite8(A,s),--o,++A;else s=this.CPUCore.memory.memoryRead8(R++),2==r?(i>>=8,i|=s<<8,1&A&&this.CPUCore.memory.memoryWrite16(A-1,i)):this.CPUCore.memory.memoryWrite8(A,s),--o,++A;C<<=1,--a}else C=this.CPUCore.memory.memoryRead8(R++),a=8},GameBoyAdvanceSWI.prototype.huffman=function(e,_){e&=4294967292;let r=this.CPUCore.memory.memoryRead32(e),C=r>>8,S=15&r;if(32%S)throw"Unimplemented unaligned Huffman";let t=4-C&3;C&=4294967292;let I,s,o,R=[],A=1+(this.CPUCore.memory.memoryRead8(e+4)<<1),a=e+5+A,i=4294967292&_;for(s=0;s<A;++s)R.push(this.CPUCore.memory.memoryRead8(e+5+s));let U,P,m=0,O=0;for(o=R[0];C>0;){let e=this.CPUCore.memory.memoryRead32(a);for(a+=4,U=32;U>0;--U,e<<=1){if("number"==typeof o){let e=(m-1|1)+((63&o)<<1)+2;o={l:e,r:e+1,lTerm:128&o,rTerm:64&o},R[m]=o}if(2147483648&e){if(!o.rTerm){m=o.r,o=R[o.r];continue}P=R[o.r]}else{if(!o.lTerm){m=o.l,o=R[m];continue}P=R[o.l]}I|=(P&(1<<S)-1)<<O,O+=S,m=0,o=R[0],32==O&&(O=0,this.CPUCore.memory.memoryWrite32(i,I),i+=4,C-=4,I=0)}}t&&this.CPUCore.memory.memoryWrite32(i,I)},GameBoyAdvanceSWI.prototype.rl=function(e,_,r){e&=4294967292;let C,S,t=(4294967040&this.CPUCore.memory.memoryRead32(e))>>8,I=4-t&3,s=e+4,o=_,R=0;for(;t>0;)if(C=this.CPUCore.memory.memoryRead8(s++),128&C)for(C&=127,C+=3,S=this.CPUCore.memory.memoryRead8(s++);C--&&t;)--t,2==r?(R>>=8,R|=S<<8,1&o&&this.CPUCore.memory.memoryWrite16(o-1,R)):this.CPUCore.memory.memoryWrite8(o,S),++o;else for(C++;C--&&t;)--t,S=this.CPUCore.memory.memoryRead8(s++),2==r?(R>>=8,R|=S<<8,1&o&&this.CPUCore.memory.memoryWrite16(o-1,R)):this.CPUCore.memory.memoryWrite8(o,S),++o;for(;I--;)this.CPUCore.memory.memoryWrite8(o++,0)};
//# sourceMappingURL=build-index.daadf3ed.js.map
